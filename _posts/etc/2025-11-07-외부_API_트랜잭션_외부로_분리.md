---
title: ë°°ì¹˜ì²˜ë¦¬ë¥¼ ì´ìš©í•œ í´ëŸ¬ìŠ¤í„°ë§ ìµœì í™”1
date: 2025-11-06
categories: [ ETC, Refactoring ]
tags: [ Refactoring, API, Transaction ]
image: assets/posts/img_21.png
---

## ğŸ¬ Intro
> ì™¸ë¶€ API í˜¸ì¶œì„ íŠ¸ëœì­ì…˜ ë°–ìœ¼ë¡œ ë¶„ë¦¬í•˜ëŠ” ê³¼ì •ì„ ë‹¤ë£¹ë‹ˆë‹¤.  

## ê²°ë¡ 

ì™¸ë¶€ API í˜¸ì¶œ ë¡œì§ì„ íŠ¸ëœì­ì…˜ ë°–ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬, ë¶ˆí•„ìš”í•œ DB ì»¤ë„¥ì…˜ ì ìœ ë¥¼ ì œê±°í•˜ì˜€ìŠµë‹ˆë‹¤. 

### í˜„ì¬ ìƒí™©
- í´ëŸ¬ìŠ¤í„°ë§ ì™¸ë¶€ APIê°€ íŠ¸ëœì­ì…˜ì•ˆì—ì„œ ì‹¤í–‰

### í˜„ì¬ ìƒí™©ì´ ì™œ ë¬¸ì œê°€ ë˜ëŠ”ê°€?

ì„ë² ë”© ë²¡í„° ì¶”ì¶œì„ ìœ„í•œ ì™¸ë¶€ API í˜¸ì¶œì´ 2ì´ˆ ì •ë„ ì†Œìš”ë˜ê¸° ë•Œë¬¸ì— ì´ë¥¼ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•œë‹¤ë©´, DBì»¤ë„¥ì…˜ê³¼ ìŠ¤ë ˆë“œ ê³ ê°ˆ ë¬¸ì œì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.

### ê°œì„  ê³¼ì •

#### âœ… ì™¸ë¶€ API íŠ¸ëœì­ì…˜ ì™¸ë¶€ë¡œ ë¶„ë¦¬

##### ì™¸ë¶€ API êµ¬ì¡°
```java
@FunctionalInterface
public interface EmbeddingExtractor {

    double[] extract(final String text);
}
```
```java
@Primary
@Component
@RequiredArgsConstructor
public class VoyageAIEmbeddingExtractorAdapter implements EmbeddingExtractor {

    private final VoyageAIEmbeddingClient voyageAIEmbeddingClient;

    @Override
    public double[] extract(final String text) {
        return voyageAIEmbeddingClient.extractEmbedding(text);
    }
}
```
ìœ„ì™€ ê°™ì´ í´ëŸ¬ìŠ¤í„°ë§ì— í•„ìš”í•œ ì„ë² ë”© ì¶”ì¶œ ì™¸ë¶€ API í˜¸ì¶œì´ ì¶”ìƒí™”ê°€ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

##### ì™¸ë¶€ API í˜¸ì¶œ ë¡œì§
###### Before
```java
   @Transactional
    public FeedbackEmbeddingCluster cluster(final Long createdFeedbackId) {
        final Feedback createdFeedback = getFeedback(createdFeedbackId);
        if (feedbackEmbeddingClusterRepository.existsByFeedback(createdFeedback)) {
            throw new AlreadyClusteringException("ì´ë¯¸ í´ëŸ¬ìŠ¤í„°ë§ ëœ í”¼ë“œë°±ì…ë‹ˆë‹¤. (feedabckId = " + createdFeedbackId + ")");
        }
        
        // ì™¸ë¶€ API í˜¸ì¶œ
        final double[] createdFeedbackEmbedding = embeddingExtractor.extract(createdFeedback.getContent().getValue());
        
        //...

        return feedbackEmbeddingClusterRepository.save(assignedCluster.get());
    }
```
ì´ì²˜ëŸ¼ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì™¸ë¶€ APIê°€ í˜¸ì¶œì€ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.  
- ì™¸ë¶€ API ì™„ë£Œ ì „ê¹Œì§€ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹
- í•´ë‹¹ ìŠ¤ë ˆë“œê°€ DB ì»¤ë„¥ì…˜ ì ìœ 

ì´ëŠ” ê³§ ìì› ê³ ê°ˆ ë¬¸ì œë¡œ ì§ê²° ë˜ê¸° ë•Œë¬¸ì— ë°˜ë“œì‹œ ê°œì„ ì´ í•„ìš”í•œ ì§€ì  ì…ë‹ˆë‹¤. ì´ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.

###### After

```java
@Service
@RequiredArgsConstructor
public class EmbeddingService {

    private final EmbeddingExtractor embeddingExtractor;

    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public double[] extractEmbedding(final String content) {
        return embeddingExtractor.extract(content);
    }
}
```
- íŠ¸ëœì­ì…˜ AOP í”„ë¡ì‹œë¥¼ ì ìš©ì„ ìœ„í•´ í´ë˜ìŠ¤ ë¶„ë¦¬  
- íŠ¸ëœì­ì…˜ ì „íŒŒ ì†ì„±ì„ `NOT_SUPPORTED`í•˜ì—¬ íŠ¸ëœì­ì…˜ ì‚¬ìš©ì„ ë°©ì§€

```java
   @Transactional
    public FeedbackEmbeddingCluster cluster(final Long createdFeedbackId) {
        final Feedback createdFeedback = getFeedback(createdFeedbackId);
        if (feedbackEmbeddingClusterRepository.existsByFeedback(createdFeedback)) {
            throw new AlreadyClusteringException("ì´ë¯¸ í´ëŸ¬ìŠ¤í„°ë§ ëœ í”¼ë“œë°±ì…ë‹ˆë‹¤. (feedabckId = " + createdFeedbackId + ")");
        }
        // ì™¸ë¶€ API í˜¸ì¶œ
        final double[] createdFeedbackEmbedding = embeddingService.extractEmbedding(createdFeedback.getContent().getValue());
        
        //...
  
        return feedbackEmbeddingClusterRepository.save(assignedCluster.get());
    }
```
ìœ„ì™€ ê°™ì´ ë³„ë„ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•œ `EmbeddingService`ì„ ì£¼ì… ë°›ì•„ ì‚¬ìš©í•˜ë©´ ì™¸ë¶€ API í˜¸ì¶œì´ íŠ¸ëœì­ì…˜ ì™¸ë¶€ë¡œ ì™„ì „íˆ ë¶„ë¦¬ë©ë‹ˆë‹¤.

ì´ë¥¼ í†µí•´ `ë¶ˆí•„ìš”í•œ DB ì»¤ë„¥ì…˜ ì ìœ ëŠ” í•´ê²°` ëìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ `ìŠ¤ë ˆë“œì˜ ê²½ìš° ë¸”ë¡œí‚¹ ìƒíƒœë¡œ ì™¸ë¶€ API ì‘ì—… ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ê²Œ ë©ë‹ˆë‹¤.`

ì´ëŠ” `ìŠ¤ì¼€ì¤„ëŸ¬ + ë°°ì¹˜ì²˜ë¦¬`ë¥¼ í†µí•´ ê°œì„  ê°€ëŠ¥í•œ í¬ì¸íŠ¸ ì…ë‹ˆë‹¤. ì‚¬ìš©ì ìš”ì²­ ì‹œì ì— ì¦‰ì‹œ ì„ë² ë”©ì„ ìƒì„±í•˜ëŠ” ëŒ€ì‹ , ì¼ì • ì£¼ê¸°ë¡œ ëª¨ì•„ì„œ ì²˜ë¦¬í•˜ë©´ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ê³¼ ë³‘ëª©ì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ í¬ìŠ¤íŒ…ì—ì„œ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤.

### [ë°°ì¹˜ì²˜ë¦¬ë¥¼ ì´ìš©í•œ í´ëŸ¬ìŠ¤í„°ë§ ìµœì í™”](/posts/ë°°ì¹˜ì²˜ë¦¬ë¥¼_ì´ìš©í•œ_í´ëŸ¬ìŠ¤í„°ë§_ìµœì í™”)
