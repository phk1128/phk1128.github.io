---
title: ë°°ì¹˜ì²˜ë¦¬ë¥¼ ì´ìš©í•œ í´ëŸ¬ìŠ¤í„°ë§ ìµœì í™”
date: 2025-11-17
categories: [ ETC, Refactoring ]
tags: [ Refactoring, Clustering ]
image: assets/posts/img_21.png
---

## ğŸ¬ Intro
> í´ëŸ¬ìŠ¤í„°ë§ì„ ì‹¤ì‹œê°„ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ì—ì„œ 2ì‹œê°„ ë°°ì¹˜ë¡œ ì „í™˜í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í•´ë´…ë‹ˆë‹¤.

## ê²°ë¡ 
ê²°ë¡ ë¶€í„° ë§ì”€ë“œë¦¬ë©´ ê¸°ì¡´ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ í´ëŸ¬ìŠ¤í„°ë§ ë˜ë˜ ë¡œì§ì„ ìŠ¤ì¼€ì¥´ëŸ¬ + ë°°ì¹˜ì²˜ë¦¬ë¥¼ í†µí•´ ì„±ëŠ¥ì„ ê°œì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

êµ¬ì²´ì ìœ¼ë¡œ `POST ìš”ì²­ 1ë²ˆë‹¹ ì™¸ë¶€ API í˜¸ì¶œ 1íšŒ` ë˜ë˜ ë¶€ë¶„ì„ `2ì‹œê°„ ì£¼ê¸° ë°°ì¹˜ë¡œ ìµœëŒ€ 100ê±´ì”© ë¬¶ì–´ ì²˜ë¦¬`í•˜ë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ `ì™¸ë¶€ API í˜¸ì¶œ íšŸìˆ˜ -> ìµœëŒ€ 1/100ë¡œ ê°ì†Œ`í•˜ì˜€ê³ , `ìˆ˜ ì‹­ì´ˆì˜ ë¶ˆí•„ìš”í•œ ë³‘ëª© í˜„ìƒ`ì„ `100%` ê°œì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

### í˜„ì¬ ìƒí™©
- POST ìš”ì²­ 1ë²ˆ ë‹¹(í”¼ë“œë°± ì‘ì„±) ë¹„ë™ê¸° ì´ë²¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë²¡í„° ê³„ì‚°ì„ ìœ„í•œ ì™¸ë¶€ API í˜¸ì¶œ

### í˜„ì¬ ìƒí™©ì´ ì™œ ë¬¸ì œê°€ ë˜ëŠ”ê°€?
í´ëŸ¬ìŠ¤í„°ë§í•˜ëŠ” ê¸°ëŠ¥ì€ ë¹„ìŠ·í•œ í”¼ë“œë°±ì„ êµ°ì§‘ìœ¼ë¡œ ë¬¶ì–´ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í†µê³„ì˜ ì˜ë¯¸ì— ê°€ê¹Œìš´ ìƒí™© ì…ë‹ˆë‹¤.
í•´ë‹¹ ê¸°ëŠ¥ì— ëŒ€í•œ ì‚¬ìš©ìì˜ í”¼ë“œë°±ì€ `ì‹¤ì‹œê°„ì„±ì´ í•„ìš” ì—†ë‹¤.` ê°€ ëŒ€ë¶€ë¶„ ì´ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì‹¤ì‹œê°„ì„±ì´ í•„ìš” ì—†ë‹¤ë©´ êµ³ì´ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ ë¡œì§ì„ ì²˜ë¦¬í•  ì´ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.

![img.png](/assets/posts/img_101.png)
![img.png](/assets/posts/img_115.png)

ì´ì²˜ëŸ¼ ì„ë² ë”© ë²¡í„° ì¶”ì¶œì„ ìœ„í•œ ì™¸ë¶€ API í˜¸ì¶œì´ 2ì´ˆ ì •ë„ ì†Œìš”ë˜ê¸° ë•Œë¬¸ì— ì´ë¥¼ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•œë‹¤ë©´, ìŠ¤ë ˆë“œ ê³ ê°ˆ ë¬¸ì œì˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.
ë˜í•œ ê°‘ì‘ìŠ¤ëŸ½ê²Œ í”¼ë“œë°±ì´ ë§ì´ ì‘ì„±ëœë‹¤ë©´, ìœ„ì™€ ê°™ì´ ì‘ë‹µì‹œê°„ì´ ì ì  ëŠë ¤ì§€ëŠ” ë³‘ëª©ì´ ìƒê¸°ê²Œ ë©ë‹ˆë‹¤.

## ê°œì„  ë°©í–¥

### âœ… Queue í…Œì´ë¸” ì¶”ê°€
#### Before
![img.png](/assets/posts/img_104.png)

- feedback_embedding_cluster : í´ëŸ¬ìŠ¤í„°ë§ ì„±ê³µ ì‹œ í”¼ë“œë°± ë°ì´í„°ê°€ ì €ì¥ë˜ëŠ” í…Œì´ë¸”
- embedding_cluster : ëŒ€í‘œ ë¬¸êµ¬(label)ë¥¼ ì €ì¥í•˜ëŠ” í…Œì´ë¸”

ê¸°ì¡´ì—ëŠ” í´ëŸ¬ìŠ¤í„°ë§ ì„±ê³µ ì‹œì—ë§Œ feedback_embedding_cluster í…Œì´ë¸”ì— ì €ì¥ë˜ëŠ” í˜•ì‹ì´ì—ˆìŠµë‹ˆë‹¤.
ì—¬ê¸°ì„œ ë¬¸ì œëŠ” í´ëŸ¬ìŠ¤í„°ë§ì´ ì‹¤íŒ¨ ì‹œ ë°ì´í„°ë¥¼ ëª¨ì•„ë‘ì§€ ì•Šê³ , ë¡œê·¸ë§Œ ë‚¨ëŠ”ë‹¤ëŠ” ì ì´ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ 2ê°€ì§€ ì„ íƒì§€ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

1. í´ëŸ¬ìŠ¤í„°ë§ ì‹¤íŒ¨ ì‹œì—ë„ feedback_embedding_cluster í…Œì´ë¸”ì— ì €ì¥, ì„±ê³µ/ì‹¤íŒ¨ í”Œë˜ê·¸ ì»¬ëŸ¼ ì¶”ê°€

2. Queue í…Œì´ë¸”ì„ ì¶”ê°€í•˜ì—¬ ì„±ê³µ/ì‹¤íŒ¨ í´ëŸ¬ìŠ¤í„°ë§ ë°ì´í„° ê´€ë¦¬

ê²°ê³¼ì ìœ¼ë¡œ 2ë²ˆ ë°©ë²•ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ê·¸ ì´ìœ ëŠ” 1ë²ˆì˜ ê²½ìš° ê¸°ì¡´ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ í•„ìš”í–ˆê³ , ë”í•´ì„œ
feedback_embedding_cluster í…Œì´ë¸”ì— ë ˆì½”ë“œê°€ ì ì  ìŒ“ì¼ë•Œë§ˆë‹¤ ì‹¤íŒ¨ ë ˆì½”ë“œ ì¡°íšŒ ì„±ëŠ¥ì´ ë¹„ë¡€í•´ì„œ ë–¨ì–´ì§€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

##### After
![img.png](/assets/posts/img_107.png)

Queue í…Œì´ë¸”ì˜ ê²½ìš° ë¶ˆí•„ìš”í•œ ì°¸ì¡°ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ í´ëŸ¬ìŠ¤í„°ë§ì— í•„ìš”í•œ ë°ì´í„°ë“¤ë¡œ `ë°˜ì •ê·œí™”` í•˜ì˜€ìŠµë‹ˆë‹¤. 
ë°°ì¹˜ ë° ì¬ì‹œë„ì˜ ê¸°ì¤€ì´ ë˜ëŠ” ì»¬ëŸ¼ì€ status, retry_count 2ê°€ì§€ ì…ë‹ˆë‹¤.

- status 
  - PENDING : ë°°ì¹˜ ì²˜ë¦¬ ëŒ€ìƒ
  - SUCCESS : ë°°ì¹˜ ì²˜ë¦¬ ì„±ê³µ
  - FAIL : ë°°ì¹˜ ì²˜ë¦¬ ì‹¤íŒ¨
- retry_count 
  - ìµœëŒ€ 3ê¹Œì§€ ì¹´ìš´íŒ…, 3ë²ˆì§¸ì—ë„ ì‹¤íŒ¨ ì‹œ status FAIL ì²˜ë¦¬

ì¶”ê°€ì ìœ¼ë¡œ SUCCESS ìƒíƒœì˜ ë ˆì½”ë“œëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ì§€ì›Œì£¼ê³ , FAILì€ ê°œë°œìê°€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ë©´ í…Œì´ë¸”ì„ ê°€ë³ê²Œ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### âœ… ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸° + ë°°ì¹˜ ë‹¨ìœ„ ì„¤ì • 

ìŠ¤ì¼€ì¥´ëŸ¬ì™€ ë°°ì¹˜ ì²˜ë¦¬ ë¡œì§ì„ êµ¬í˜„í•˜ê¸°ì— ì•ì„œ ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸°ì™€ ë°°ì¹˜ ë‹¨ìœ„ë¥¼ ë¨¼ì € ê²°ì •í•´ì•¼í•©ë‹ˆë‹¤.

#### ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸° = 2ì‹œê°„
ìš°í…Œì½” ì½”ì¹˜ë‹˜ë“¤ì´ ë§¤ ê°•ì˜ ë§ˆë‹¤ ì €í¬ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ê³„ì‹œê¸° ë•Œë¬¸ì—, ê°•ì˜ì˜ í‰ê·  ì‹œê°„ì„ ê³ ë ¤í•´ì„œ ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸°ë¥¼ 2ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

#### ë°°ì¹˜ ë‹¨ìœ„ = 100ê°œ
![img.png](/assets/posts/img_106.png)
[voyage ai ê³µì‹ ë¬¸ì„œ](https://docs.voyageai.com/docs/rate-limits)ì— ë”°ë¥´ë©´ ì €í¬ ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•˜ê³  ìˆëŠ” voyage-3.5 ëª¨ë¸ì˜ ê²½ìš° limitì´ TPM = 8,000,000 / RPM = 2,000 ì…ë‹ˆë‹¤.
TPMì€ ë¶„ë‹¹ ìš”ì²­í•  ìˆ˜ ìˆëŠ” í† í° ìˆ˜, RPMì€ ë¶„ë‹¹ ìš”ì²­í•  ìˆ˜ ìˆëŠ” ìš”ì²­ ìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. 

- í•œê¸€ 1ê¸€ì ë‹¹ 3ê°œì˜ í† í° ì‚¬ìš©
- ë§¤ ê°•ì˜ì‹œ 100ê¸€ì ì´ë‚´ì˜ í”¼ë“œë°±ì´ 50ê°œ ìƒì„± ë¨

ìœ„ ìƒí™©ì„ ê³ ë ¤í–ˆì„ë•Œ 50ê°œì˜ í”¼ë“œë°±ì„ ìš”ì²­í•œë‹¤ë©´, 3 * 100 * 50 = 15,000 í† í°ì´ ì‚¬ìš© ë©ë‹ˆë‹¤. ë§Œì•½ ê°•ì˜ê°€ 10ê°œë¼ê³  ê°€ì •í•´ë„ TPMì€ ì—¬ìœ ë¡œìš´ ìƒí™©ì…ë‹ˆë‹¤.
ë”°ë¼ì„œ ì„œë¹„ ë©”ëª¨ë¦¬ì™€ RPMì„ ê³ ë ¤í•´ì„œ ë°°ì¹˜ ë‹¨ìœ„ëŠ” 100ê°œë¡œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

### âœ… ìŠ¤ì¼€ì¥´ëŸ¬ + ë°°ì¹˜ ë¡œì§ êµ¬í˜„

![img.png](/assets/posts/img_112.png)

2ì‹œê°„ ë§ˆë‹¤ ìœ„ì™€ ê°™ì€ ì‘ì—…ì„ í•˜ê²Œ ë©ë‹ˆë‹¤.`ë¶„ì‚°í™˜ê²½`ì¸ ì ì„ ê³ ë ¤í•´ì„œ `ìŠ¤ì¼€ì¥´ëŸ¬ ì‹œì‘ì‹œ shedLock`ì„ ê±¸ì–´ì¤ë‹ˆë‹¤. ë˜í•œ ì—¬ê¸°ì„œ ê° ë²Œí¬ì—°ì‚°ì˜ íŠ¸ëœì­ì…˜ A,Bë¡œ ë¶„ë¦¬ë˜ì–´ ìˆëŠ”ë° ê·¸ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. FeedbackEmbeddingClusterê°€ EmbeddingClusterë¥¼ ì°¸ì¡° í•˜ë¯€ë¡œ EmbeddingCluster ë²Œí¬ ì—°ì‚°ì´ ì»¤ë°‹ì´ ë˜ì–´ì•¼í•¨ 
2. FeedbackEmbeddingCluster ì²˜ë¦¬ ê³¼ì •ì—ì„œ ì™¸ë¶€ APIë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ `EmbeddingCluster ë²Œí¬ ì—°ì‚°ì´ ì‹¤íŒ¨ í•˜ë”ë¼ë„ ë¡¤ë°± ë˜ë©´ ì•ˆëŒ`

ê·¸ë¦¬ê³  1ë²ˆ ìƒí™©ì˜ ê²½ìš°ëŠ” JDBCì—ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ ë²Œí¬ ì—°ì‚° í›„ ê°ì²´ì— idë¥¼ í• ë‹¹í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í•˜ì—¬ EmbeddingCluster, FeedbackEmbeddingClusterë¥¼
ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ì½”ë“œë¥¼ ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

#### ë²Œí¬ ì—°ì‚° íŠ¸ëœì­ì…˜ ë¶„ë¦¬
```java
@Slf4j
@Component
@RequiredArgsConstructor
public class EmbeddingClusterBulkInserter {

    private final EmbeddingClusterRepository embeddingClusterRepository;
    private final FeedbackEmbeddingClusterRepository feedbackEmbeddingClusterRepository;

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void bulkInsertEmbeddingClusters(List<EmbeddingCluster> newEmbeddingClusters) {
        log.info("EmbeddingClusters Bulk Insert Start");
        embeddingClusterRepository.bulkInsert(newEmbeddingClusters);
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void bulkInsertFeedbackEmbeddingClusters(List<FeedbackEmbeddingCluster> feedbackEmbeddingClusters) {
        log.info("FeedbackEmbeddingClusters Bulk Insert Start");
        feedbackEmbeddingClusterRepository.bulkInsert(feedbackEmbeddingClusters);
    }
}
```

#### ë²Œí¬ ì—°ì‚° í›„ ê°ì²´ì— ID í• ë‹¹
```java
@Slf4j
@Repository
@RequiredArgsConstructor
public class EmbeddingClusterCustomRepositoryImpl implements EmbeddingClusterCustomRepository {

    private static final String INSERT_QUERY_PREFIX = "INSERT INTO embedding_cluster (label, created_at, modified_at) VALUES ";
    private static final String LAST_INSERT_ID_QUERY = "SELECT LAST_INSERT_ID()";

    private final NamedParameterJdbcTemplate namedParameterJdbcTemplate;

    @Override
    public List<EmbeddingCluster> bulkInsert(List<EmbeddingCluster> clusters) {
        if (clusters.isEmpty()) {
            return Collections.emptyList();
        }
        MapSqlParameterSource parameters = createParameters(clusters);
        String insertQuery = buildInsertQuery(clusters.size());
        executeInsert(insertQuery, parameters);
        assignGeneratedIds(clusters);
        return clusters;
    }

    private String buildInsertQuery(int clusterCount) {
        StringBuilder sql = new StringBuilder(INSERT_QUERY_PREFIX);
        for (int i = 0; i < clusterCount; i++) {
            sql.append(buildValuePlaceholder(i));
            if (i < clusterCount - 1) {
                sql.append(", ");
            }
        }
        return sql.toString();
    }

    private String buildValuePlaceholder(int index) {
        return String.format("(:label%d, :createdAt%d, :modifiedAt%d)", index, index, index);
    }

    private MapSqlParameterSource createParameters(List<EmbeddingCluster> clusters) {
        MapSqlParameterSource parameters = new MapSqlParameterSource();
        LocalDateTime now = LocalDateTime.now();

        for (int i = 0; i < clusters.size(); i++) {
            EmbeddingCluster cluster = clusters.get(i);
            parameters.addValue("label" + i, cluster.getLabel());
            parameters.addValue("createdAt" + i, now);
            parameters.addValue("modifiedAt" + i, now);
        }

        return parameters;
    }

    private void executeInsert(String query, MapSqlParameterSource parameters) {
        namedParameterJdbcTemplate.update(query, parameters);
    }

    private void assignGeneratedIds(List<EmbeddingCluster> clusters) {
        Long firstId = getLastInsertId();

        for (int i = 0; i < clusters.size(); i++) {
            clusters.get(i).setId(firstId + i);
        }
    }

    private Long getLastInsertId() {
        return namedParameterJdbcTemplate.queryForObject(
                LAST_INSERT_ID_QUERY,
                new MapSqlParameterSource(),
                Long.class
        );
    }
}
```

#### ìŠ¤ì¼€ì¥´ëŸ¬
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class FeedbackClusteringBatchScheduler {
    
    private static final int BATCH_SIZE = 100;

    private final FeedbackClusteringQueueRepository queueRepository;
    private final FeedbackClusteringBatchService batchProcessor;


    @Scheduled(cron = "0 0 */2 * * *")
    @SchedulerLock(name = "feedbackClusteringBatch", lockAtMostFor = "PT60M")
    public void clusterUnclusteredFeedbacks() {
        log.info("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] ì‹œì‘");

        int totalProcessed = 0;
        int totalFailed = 0;
        int batchCount = 0;

        while (true) {
            List<FeedbackClusteringQueue> queues = findPendingQueues();
            if (queues.isEmpty()) {
                break;
            }

            log.info("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] {}ë²ˆì§¸ ë°°ì¹˜ ì²˜ë¦¬ ì‹œì‘ - {}ê°œ", batchCount, queues.size());

            Map<UUID, List<FeedbackClusteringQueue>> queuesByOrg = groupByOrganization(queues);
            int processed = processAllOrganizations(queuesByOrg);

            totalProcessed += processed;
            totalFailed += (queues.size() - processed);

            log.info("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] {}ë²ˆì§¸ ë°°ì¹˜ ì™„ë£Œ - ì„±ê³µ: {}ê°œ, ì‹¤íŒ¨: {}ê°œ",
                    batchCount, processed, queues.size() - processed);

            batchCount++;
        }
        log.info("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] ì „ì²´ ì™„ë£Œ - ì´ ì„±ê³µ: {}ê°œ, ì´ ì‹¤íŒ¨: {}ê°œ", totalProcessed, totalFailed);
    }

    private List<FeedbackClusteringQueue> findPendingQueues() {
        return queueRepository.findPendingQueues(PageRequest.of(0, BATCH_SIZE));
    }

    private Map<UUID, List<FeedbackClusteringQueue>> groupByOrganization(List<FeedbackClusteringQueue> queues) {
        return queues.stream()
                .collect(Collectors.groupingBy(FeedbackClusteringQueue::getOrganizationUuid));
    }

    private int processAllOrganizations(Map<UUID, List<FeedbackClusteringQueue>> queuesByOrg) {
        int totalProcessed = 0;
        for (Map.Entry<UUID, List<FeedbackClusteringQueue>> entry : queuesByOrg.entrySet()) {
            UUID orgUuid = entry.getKey();
            List<FeedbackClusteringQueue> orgQueues = entry.getValue();

            try {
                int processed = processOrganizationQueues(orgQueues);
                totalProcessed += processed;
            } catch (Exception e) {
                log.error("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] ì¡°ì§ {} ì²˜ë¦¬ ì‹¤íŒ¨", orgUuid, e);
            }
        }
        return totalProcessed;
    }

    private int processOrganizationQueues(List<FeedbackClusteringQueue> queues) {
        int processedCount = 0;
        for (int i = 0; i < queues.size(); i += BATCH_SIZE) {
            int endIndex = Math.min(i + BATCH_SIZE, queues.size());
            List<FeedbackClusteringQueue> batch = queues.subList(i, endIndex);

            try {
                final List<ClusteringResult> clusteringResults = batchProcessor.processBatch(batch);
                processedCount += clusteringResults.size();
                batchProcessor.createLabelsForNewClusters(clusteringResults);
            } catch (Exception e) {
                log.error("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] ë°°ì¹˜ ì²˜ë¦¬ ì‹¤íŒ¨ (index: {}-{})", i, endIndex, e);
            }
        }
        return processedCount;
    }
}
```


![img.png](/assets/posts/img_109.png)

ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œì§ì— ì‚¬ìš©ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ ë³´ìë©´ ì´ 8ê°œ ì˜€ê³ , ê° ì—­í• ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- FeedbackClusteringBatchScheduler
  - 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬, PENDING ìƒíƒœì¸ í”¼ë“œë°±ì„ 100ê°œì”© ì¡°íšŒí•˜ê³  ì¡°ì§ë³„ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ì¡°ìœ¨
- FeedbackClusteringBatchService
  - 100ê°œ í”¼ë“œë°±ì˜ ì„ë² ë”© ì¶”ì¶œ -> í´ëŸ¬ìŠ¤í„°ë§ -> ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì¬ì‹œë„ ì¹´ìš´íŒ… ì²˜ë¦¬
- FeedbackClusteringService
  - EmbeddingClustering ë¼ë²¨ ìƒì„±
- EmbeddingClusteringBulkInserter
  - FeedbackEmbeddingCluster Bulk Insert
  - EmbeddingCluster Bulk Insert
- EmbeddingClusterRepository
  - EmbeddingCluster ë„ë©”ì¸ JPA ë ˆíŒŒì§€í† ë¦¬
- EmbeddingClusterCustomRepository
  - EmbeddingCluster ë„ë©”ì¸ JDBC ë ˆíŒŒì§€í† ë¦¬ (ë²Œí¬ ì—°ì‚°) 
- FeedbackEmbeddingClusterRepository
  - FeedbackEmbeddingClusterRepository ë„ë©”ì¸ JPA ë ˆíŒŒì§€í† ë¦¬
- FeedbackEmbeddingClusterCustomRepository
  - FeedbackEmbeddingClusterCustomRepository ë„ë©”ì¸ JDBC ë ˆíŒŒì§€í† ë¦¬ (ë²Œí¬ ì—°ì‚°)

## ì„±ê³¼
### âœ… ë°˜ë³µì ì¸ ì™¸ë¶€ API í˜¸ì¶œ ì‹œê°„ ì œê±° -> 1/100íšŒ
#### Before
![img.png](/assets/posts/img_101.png)
#### After
![img.png](/assets/posts/img_113.png)

### âœ… ë³‘ëª© í˜„ìƒ 100% ì œê±°
#### Before
![img.png](/assets/posts/img_115.png)
#### After
![img.png](/assets/posts/img_114.png)

### âœ… ì¬ì‹œë„ ê°€ëŠ¥í•œ ì•ˆì •ì ì¸ í´ëŸ¬ìŠ¤í„°ë§ í™˜ê²½ êµ¬ì¶•

#### Before
ì‹¤íŒ¨ â†’ ë¡œê·¸ë§Œ ë‚¨ê¹€ â†’ ë â†’ í•´ë‹¹ í”¼ë“œë°±ì€ ì˜ì›íˆ í´ëŸ¬ìŠ¤í„°ë§ ì•ˆ ë¨

#### After
ì‹¤íŒ¨ â†’ íì— retry_count ì¹´ìš´íŒ… â†’ retry_count < 3ì¼ ê²½ìš° ë‹¤ìŒ ë°°ì¹˜ì—ì„œ ìë™ ì¬ì‹œë„ 

## ë§ˆë¬´ë¦¬ í•˜ë©°
ì´ë²ˆ ë¦¬íŒ©í† ë§ì€ `ì„±ëŠ¥ ê°œì„ `ì— ì§‘ì¤‘í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ `ìŠ¤ì¼€ì¤„ëŸ¬ + ë°°ì¹˜ ì²˜ë¦¬`, `JDBC ë²Œí¬ ì—°ì‚°`ì„ í™œìš©í•´ë³´ì•˜ê³ , ê·¸ ê³¼ì •ì—ì„œ `shedLock` ê°œë…ë„ í•™ìŠµí•´ë³¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ì™„ë²½í•œ ì„¤ê³„ëŠ” ì•„ë‹ˆì§€ë§Œ, íŒ€ ë‚´ì—ì„œ ê³ ë¯¼ì´ì—ˆë˜ `ë³‘ëª© í˜„ìƒ`ê³¼ `ì¬ì‹œë„ ì²˜ë¦¬`ë¥¼ í•œë²ˆì— í•´ê²°í•  ìˆ˜ ìˆì—ˆì–´ì„œ ë¿Œë“¯í–ˆìŠµë‹ˆë‹¤.
