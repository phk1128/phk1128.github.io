---
title: ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì‘ì—… ë™ì  ìŠ¤ì¼€ì¥´ëŸ¬ + ë°°ì¹˜ì²˜ë¦¬ë¡œ ê°œì„ í•˜ê¸°
date: 2025-11-17
categories: [ ETC, Refactoring ]
tags: [ Refactoring, Clustering ]
image: assets/posts/img_21.png
---

## ğŸ¬ Intro
> ì‹¤ì‹œê°„ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‘ì—…ì„ ë™ì  ìŠ¤ì¼€ì¥´ëŸ¬ + ë°°ì¹˜ë¡œ ì „í™˜í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í•´ë´…ë‹ˆë‹¤.

## ê²°ë¡ 
ê²°ë¡ ë¶€í„° ë§ì”€ë“œë¦¬ë©´ ê¸°ì¡´ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ í´ëŸ¬ìŠ¤í„°ë§ ë˜ë˜ ë¡œì§ì„ ë™ì  ìŠ¤ì¼€ì¥´ëŸ¬ + ë°°ì¹˜ì²˜ë¦¬ë¥¼ í†µí•´ ì„±ëŠ¥ì„ ê°œì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

êµ¬ì²´ì ìœ¼ë¡œ `POST ìš”ì²­ 1ë²ˆë‹¹ ì™¸ë¶€ API í˜¸ì¶œ 1íšŒ` ë˜ë˜ ë¶€ë¶„ì„ `ë™ì  ì£¼ê¸° ë°°ì¹˜ë¡œ ìµœëŒ€ 100ê±´ì”© ë¬¶ì–´ ì²˜ë¦¬`í•˜ë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ `ì™¸ë¶€ API í˜¸ì¶œ íšŸìˆ˜ -> ìµœëŒ€ 1/100ë¡œ ê°ì†Œ`í•˜ì˜€ê³ , `ì•½ 7ì´ˆì´ìƒì˜ ì²˜ë¦¬ ì§€ì—°`ì„ `0.06ì´ˆ`ë¡œ ê°œì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

### í˜„ì¬ ìƒí™©
- POST ìš”ì²­ 1ë²ˆ ë‹¹(í”¼ë“œë°± ì‘ì„±) ë¹„ë™ê¸° ì´ë²¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë²¡í„° ê³„ì‚°ì„ ìœ„í•œ ì™¸ë¶€ API í˜¸ì¶œ

### í˜„ì¬ ìƒí™©ì´ ì™œ ë¬¸ì œê°€ ë˜ëŠ”ê°€?
AI í´ëŸ¬ìŠ¤í„°ë§í•˜ëŠ” ê¸°ëŠ¥ì€ ë¹„ìŠ·í•œ í”¼ë“œë°±ì„ êµ°ì§‘ìœ¼ë¡œ ë¬¶ì–´ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í†µê³„ì˜ ì˜ë¯¸ì— ê°€ê¹Œìš´ ìƒí™©ì´ë¯€ë¡œ
í•´ë‹¹ ê¸°ëŠ¥ì€ `ì‹¤ì‹œê°„ì„±ì´ í•„ìš” ì—†ë‹¤.` ê°€ ì—†ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ì„±ì´ í•„ìš” ì—†ë‹¤ë©´ êµ³ì´ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ ë¡œì§ì„ ì²˜ë¦¬í•  ì´ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.

![img.png](/assets/posts/img_101.png)
![img.png](/assets/posts/img_115.png)

ë˜í•œ í´ëŸ¬ìŠ¤í„°ë§ ì‘ì—…ì˜ ê²½ìš° ì™¸ë¶€ API í˜¸ì¶œì´ í•„ìš”í•˜ë¯€ë¡œ ê°‘ì‘ìŠ¤ëŸ½ê²Œ í”¼ë“œë°±ì´ ë§ì´ ì‘ì„±ëœë‹¤ë©´, ìœ„ì™€ ê°™ì´ ì‘ë‹µì‹œê°„ì´ ì ì  ëŠë ¤ì§€ëŠ” ë³‘ëª©ì´ ìƒê¸°ê²Œ ë©ë‹ˆë‹¤.

## ê°œì„  ë°©í–¥

ì‹¤ì‹œê°„ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¡œ ì²˜ë¦¬í•˜ë˜ í´ëŸ¬ìŠ¤í„°ë§ ë¡œì§ì„ ë™ì  ìŠ¤ì¼€ì¤„ëŸ¬ ê¸°ë°˜ ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì „í™˜í•˜ì˜€ìŠµë‹ˆë‹¤.
ë°°ì¹˜ ë‹¨ìœ„ì™€ ì‹¤í–‰ ì£¼ê¸°ëŠ” ì™¸ë¶€ API ì‘ë‹µ ì‹œê°„ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì¡°ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

### âœ… ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸° + ë°°ì¹˜ ë‹¨ìœ„ ì„¤ì • 

ìŠ¤ì¼€ì¥´ëŸ¬ì™€ ë°°ì¹˜ ì²˜ë¦¬ ë¡œì§ì„ êµ¬í˜„í•˜ê¸°ì— ì•ì„œ ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸°ì™€ ë°°ì¹˜ ë‹¨ìœ„ë¥¼ ë¨¼ì € ê²°ì •í•´ì•¼í•©ë‹ˆë‹¤.

#### ë°°ì¹˜ ë‹¨ìœ„ = 100ê°œ
![img.png](/assets/posts/img_106.png)
[voyage ai ê³µì‹ ë¬¸ì„œ](https://docs.voyageai.com/docs/rate-limits)ì— ë”°ë¥´ë©´ ì €í¬ ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•˜ê³  ìˆëŠ” voyage-3.5 ëª¨ë¸ì˜ ê²½ìš° limitì´ TPM = 8,000,000 / RPM = 2,000 ì…ë‹ˆë‹¤.
TPMì€ ë¶„ë‹¹ ìš”ì²­í•  ìˆ˜ ìˆëŠ” í† í° ìˆ˜, RPMì€ ë¶„ë‹¹ ìš”ì²­í•  ìˆ˜ ìˆëŠ” ìš”ì²­ ìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. 

- í•œê¸€ 1ê¸€ì ë‹¹ 3ê°œì˜ í† í° ì‚¬ìš©
- ë§¤ ê°•ì˜ì‹œ 100ê¸€ì ì´ë‚´ì˜ í”¼ë“œë°±ì´ 50ê°œ ìƒì„± ë¨

ìœ„ ìƒí™©ì„ ê³ ë ¤í–ˆì„ë•Œ 50ê°œì˜ í”¼ë“œë°±ì„ ìš”ì²­í•œë‹¤ë©´, 3 * 100 * 50 = 15,000 í† í°ì´ ì‚¬ìš© ë©ë‹ˆë‹¤. ë§Œì•½ ê°•ì˜ê°€ 10ê°œë¼ê³  ê°€ì •í•´ë„ TPMì€ ì—¬ìœ ë¡œìš´ ìƒí™©ì…ë‹ˆë‹¤.
ë”°ë¼ì„œ ì„œë¹„ ë©”ëª¨ë¦¬ì™€ RPMì„ ê³ ë ¤í•´ì„œ ë°°ì¹˜ ë‹¨ìœ„ëŠ” 100ê°œë¡œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

#### ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸°
ë°°ì¹˜ ë‹¨ìœ„ `100ê°œ`ì¼ ê²½ìš° í‰ê·  ì‘ë‹µ ì‹œê°„ì´ `5ì´ˆ` ì…ë‹ˆë‹¤. ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ê¸°ë³¸ ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸°ë¥¼ `1ë¶„` ìœ¼ë¡œ í•˜ê³  ë‹¤ìŒê³¼ ê°™ì´ ë™ì ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.
```text
ì‘ë‹µ ì‹œê°„ â‰¤ 5,000ms  : í´ë§ ì£¼ê¸° = 60,000ms (ê³ ì •)
ì‘ë‹µ ì‹œê°„ > 5,000ms  : í´ë§ ì£¼ê¸° = 60,000ms Ã— (ì‘ë‹µ ì‹œê°„ / 5,000ms)
```

### âœ… ìŠ¤ì¼€ì¥´ëŸ¬ + ë°°ì¹˜ ë¡œì§ êµ¬í˜„

#### ìŠ¤ì¼€ì¥´ëŸ¬
```java
@SchedulerLock(name = "feedbackClusteringBatch", lockAtMostFor = "PT30M")
public void clusterUnclusteredFeedbacks() {
    long startTime = System.currentTimeMillis();
    log.info("[í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜] ì‹œì‘");
    List<FeedbackClusteringQueue> queues = queueRepository.findPendingQueues(BATCH_SIZE);
    
    /*
  
      í´ëŸ¬ìŠ¤í„°ë§ ì‘ì—…
      
     */
  
    long responseTime = System.currentTimeMillis() - startTime; 
    intervalCalculator.updateExecutionTime(responseTime);
}
```
- BATCH_SIZE = 100ìœ¼ë¡œ í•˜ì—¬ 100ê°œì”© í´ëŸ¬ìŠ¤í„°ë§ ì‘ì—…ì„ ë¬¶ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤
- í´ëŸ¬ìŠ¤í„°ë§ ë°°ì¹˜ ì‘ì—… ì´í›„ ì‘ë‹µ ì‹œê°„ì„ ê³„ì‚°í•˜ì—¬ ìŠ¤ì¼€ì¥´ë§ ì£¼ê¸°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤

#### ìŠ¤ì¼€ì¥´ëŸ¬ ë“±ë¡
```java
@Configuration
@RequiredArgsConstructor
public class FeedbackClusteringSchedulingConfig implements SchedulingConfigurer {

    private final FeedbackClusteringBatchScheduler feedbackClusteringBatchScheduler;
    private final FeedbackClusteringAdaptiveTrigger feedbackClusteringAdaptiveTrigger;

    @Override
    public void configureTasks(final ScheduledTaskRegistrar taskRegistrar) {
        taskRegistrar.addTriggerTask(
                feedbackClusteringBatchScheduler::clusterUnclusteredFeedbacks,
                feedbackClusteringAdaptiveTrigger
        );
    }
}
```
- í´ëŸ¬ìŠ¤í„°ë§ ìŠ¤ì¼€ì¥´ëŸ¬ë¥¼ Spring TaskSchedulerì— ë“±ë¡í•˜ëŠ” ì„¤ì • í´ë˜ìŠ¤ ì…ë‹ˆë‹¤

#### ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸° ì¬ì„¤ì •
```java
@Component
@RequiredArgsConstructor
public class FeedbackClusteringAdaptiveTrigger implements Trigger {

  private final FeedbackClusteringSchedulerTimeCalculator feedbackClusteringSchedulerTimeCalculator;

  @Override
  public Instant nextExecution(final TriggerContext triggerContext) {
    Instant lastCompletion = triggerContext.lastCompletion();
    Instant now = Instant.now();
    Instant baseTime = (lastCompletion != null) ? lastCompletion : now;

    Duration interval = feedbackClusteringSchedulerTimeCalculator.calculateNextInterval();
    return baseTime.plus(interval);
  }
}
```
- Spring TaskSchedulerì— ë“±ë¡ëœ í´ëŸ¬ìŠ¤í„°ë§ì˜ ìŠ¤ì¼€ì¥´ëŸ¬ ì£¼ê¸°ë¥¼ ì¬ì„¤ì •í•˜ëŠ” í´ë˜ìŠ¤ ì…ë‹ˆë‹¤.
- ë‹¤ìŒ ìŠ¤ì¼€ì¥´ëŸ¬ ì‹¤í–‰ ì‹œê°„ì€ `í˜„ì¬ ì‹œê°„ + ë™ì ìœ¼ë¡œ ê³„ì‚°ëœ ìŠ¤ì¼€ì¤„ë§ ì£¼ê¸°` ì…ë‹ˆë‹¤. 

#### ë²Œí¬ ì—°ì‚°
```java
@Slf4j
@Component
@RequiredArgsConstructor
public class EmbeddingClusterBulkInserter {

    private final EmbeddingClusterRepository embeddingClusterRepository;
    private final FeedbackEmbeddingClusterRepository feedbackEmbeddingClusterRepository;

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void bulkInsertEmbeddingClusters(List<EmbeddingCluster> newEmbeddingClusters) {
        log.info("EmbeddingClusters Bulk Insert Start");
        embeddingClusterRepository.bulkInsert(newEmbeddingClusters);
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void bulkInsertFeedbackEmbeddingClusters(List<FeedbackEmbeddingCluster> feedbackEmbeddingClusters) {
        log.info("FeedbackEmbeddingClusters Bulk Insert Start");
        feedbackEmbeddingClusterRepository.bulkInsert(feedbackEmbeddingClusters);
    }
}
```
- ë°°ì¹˜ ì‘ì—…ì´ ì™„ë£Œëœ í´ëŸ¬ìŠ¤í„°ë§ì„ ì €ì¥í•˜ê¸° ìœ„í•´ JDBC ë²Œí¬ ì—°ì‚°ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

![img.png](/assets/posts/img_109.png)

ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œì§ì— ì‚¬ìš©ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ ë³´ìë©´ ì´ 8ê°œ ì˜€ê³ , ê° ì—­í• ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- FeedbackClusteringBatchScheduler
  - 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬, PENDING ìƒíƒœì¸ í”¼ë“œë°±ì„ 100ê°œì”© ì¡°íšŒí•˜ê³  ì¡°ì§ë³„ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ì¡°ìœ¨
- FeedbackClusteringBatchService
  - 100ê°œ í”¼ë“œë°±ì˜ ì„ë² ë”© ì¶”ì¶œ -> í´ëŸ¬ìŠ¤í„°ë§ -> ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì¬ì‹œë„ ì¹´ìš´íŒ… ì²˜ë¦¬
- FeedbackClusteringService
  - EmbeddingClustering ë¼ë²¨ ìƒì„±
- EmbeddingClusteringBulkInserter
  - FeedbackEmbeddingCluster Bulk Insert
  - EmbeddingCluster Bulk Insert
- EmbeddingClusterRepository
  - EmbeddingCluster ë„ë©”ì¸ JPA ë ˆíŒŒì§€í† ë¦¬
- EmbeddingClusterCustomRepository
  - EmbeddingCluster ë„ë©”ì¸ JDBC ë ˆíŒŒì§€í† ë¦¬ (ë²Œí¬ ì—°ì‚°) 
- FeedbackEmbeddingClusterRepository
  - FeedbackEmbeddingClusterRepository ë„ë©”ì¸ JPA ë ˆíŒŒì§€í† ë¦¬
- FeedbackEmbeddingClusterCustomRepository
  - FeedbackEmbeddingClusterCustomRepository ë„ë©”ì¸ JDBC ë ˆíŒŒì§€í† ë¦¬ (ë²Œí¬ ì—°ì‚°)

## ì„±ê³¼
### âœ… ë°˜ë³µì ì¸ ì™¸ë¶€ API í˜¸ì¶œ ì‹œê°„ ì œê±° -> 1/100íšŒ
#### Before
![img.png](/assets/posts/img_101.png)
#### After
![img.png](/assets/posts/img_113.png)

### âœ… ì•½ 7ì´ˆ ì´ìƒ ì²˜ë¦¬ ì§€ì—° -> 0.06ì´ˆë¡œ ê°œì„ 
#### Before
![img.png](/assets/posts/img_115.png)
#### After
![img.png](/assets/posts/img_114.png)

## ë§ˆë¬´ë¦¬ í•˜ë©°
ì´ë²ˆ ë¦¬íŒ©í† ë§ì€ `ì„±ëŠ¥ ê°œì„ `ì— ì§‘ì¤‘í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ `ìŠ¤ì¼€ì¤„ëŸ¬ + ë°°ì¹˜ ì²˜ë¦¬`, `JDBC ë²Œí¬ ì—°ì‚°`ì„ í™œìš©í•´ë³´ì•˜ê³ , ê·¸ ê³¼ì •ì—ì„œ `shedLock` ê°œë…ë„ í•™ìŠµí•´ë³¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ì™„ë²½í•œ ì„¤ê³„ëŠ” ì•„ë‹ˆì§€ë§Œ, íŒ€ ë‚´ì—ì„œ ê³ ë¯¼ì´ì—ˆë˜ `ë³‘ëª© í˜„ìƒ`ì„ í•´ê²°í•  ìˆ˜ ìˆì—ˆì–´ì„œ ë¿Œë“¯í–ˆìŠµë‹ˆë‹¤.
