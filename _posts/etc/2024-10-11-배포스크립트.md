---
title: Github Actions
date: 2024-10-11
categories: [ ETC, github actions ]
tags: [ github actions, cicd ]
image: assets/posts/img_55.png
---
## ğŸ¬Intro
> github actionsì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

### âœ… Github actions
githubì—ì„œ ì œê³µí•˜ëŠ” ìë™í™” ë„êµ¬ì…ë‹ˆë‹¤. githubì˜ íŠ¹ì • ë¸Œëœì¹˜ë¡œ pushë‚˜ prì´ ë°œìƒí• ë•Œ ê°œë°œìê°€ ì •ì˜í•´ë†“ì€ ì‘ì—…ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.
í•´ë‹¹ ì‘ì—…ë“¤ì€ githubê°€ ì œê³µí•˜ëŠ” ê°€ìƒí™˜ê²½(í´ë¼ìš°ë“œ pc)ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.

#### 1. workflow
- íŠ¹ì • ì´ë²¤íŠ¸(push í˜¹ì€ pr)ê°€ ë°œìƒí•˜ë©´ ì‹¤í–‰ë˜ëŠ” ì‘ì—…ì…ë‹ˆë‹¤.
- `.github/workflows` í´ë” ë‚´ì˜ YAML íŒŒì¼ë¡œ ì •ì˜ë©ë‹ˆë‹¤.

#### 2. Job
- workflow ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì‘ì—… ë‹¨ìœ„ì…ë‹ˆë‹¤.
- ì—¬ëŸ¬ jobìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆìœ¼ë©°, ê° jobì€ ì„œë¡œ `ë…ë¦½ëœ ê°€ìƒí™˜ê²½`ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

#### 3. Step
- Job ì•ˆì—ì„œ ì‹¤í–‰ë˜ëŠ” ì‘ì—…ì˜ ì„¸ë¶€ ë‹¨ê³„ì…ë‹ˆë‹¤.
- ê° Stepì€ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ ì‘ì—…ì„ ì •ì˜í•  ìˆ˜ ìˆê³  ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ ë†“ì€ ì•¡ì…˜ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 4. Action
- ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ ë†“ì€ ì‘ì—… ì…ë‹ˆë‹¤. ì¦‰, ëª¨ë“ˆì´ë¼ê³  ì´í•´í•˜ì‹œë©´ ë©ë‹ˆë‹¤.


### ğŸ“ ì˜ˆì‹œ
í˜„ì¬ ì‚¬ì´ë“œí”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” CI/CD ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì˜ˆë¡œ ë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.

#### Jobs

##### build
1. main ë˜ëŠ” develop ë¸Œëœì¹˜ë¡œ prì´ ë°œìƒ
2. ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ìœ„ì¹˜í•œ github ë ˆí¬ì§€í† ë¦¬ë¡œ ì²´í¬ì•„ì›ƒ
3. JDK 17 ì„¤ì¹˜
4. gradlew íŒŒì¼ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ê¶Œí•œë¶€ì—¬
5. gradleì„ í†µí•´ ë¹Œë“œ
6. ë„ì»¤í—ˆë¸Œ ë¡œê·¸ì¸
7. prì— ë”°ë¥¸ ë„ì»¤ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì • develop -> ê°œë°œ, main -> ìš´ì˜
8. ë„ì»¤ ë¹Œë“œ & ë„ì»¤í—ˆë¸Œì— í‘¸ì‹œ

##### deploy
1. build jobì´ ì„±ê³µí–ˆì„ ê²½ìš°ì— ì‹¤í–‰
2. prì— ë”°ë¥¸ ë°°í¬ íƒ€ê²Ÿ ì„¤ì • develop -> ê°œë°œ, main -> ìš´ì˜
3. EC2 ì›ê²© ì ‘ì† ë° ë„ì»¤ì»´í¬ì¦ˆë¥¼ ì´ìš©í•œ ë¹Œë“œ

#### CI/CD Script

```yaml
# ì›Œí¬í”Œë¡œìš° ì´ë¦„ ì„¤ì •
name: Java CI/CD with Gradle

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
# main, develop ë¸Œëœì¹˜ì— prì´ ë°œìƒí–ˆì„ë•Œ ì‹¤í–‰
on:
  pull_request:
    branches: [ main, develop ]

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì„ ìœ„í•´ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: read

# ì‘ì—… ì •ì˜
# 1. build
# 2. deploy
jobs:
  # 1. build
  build:
    runs-on: ubuntu-22.04 # ìš°ë¶„íˆ¬ì—ì„œ ì‹¤í–‰
    # ì‘ì—… ìŠ¤í…
    steps:
      # ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì˜¬ë¼ê°€ ìˆëŠ” ë ˆí¬ì§€í† ë¦¬ë¡œ ì²´í¬ì•„ì›ƒ
      # ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ë†“ì€ ì•¡ì…˜ ì´ìš©
      - name: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SUBMODULE_TOKEN }} # ì„œë¸Œëª¨ë“ˆ ì ‘ê·¼ì„ ìœ„í•œ í† í°
          submodules: true # ì„œë¸Œëª¨ë“ˆë“¤ë„ í•¨ê»˜ ê°€ì ¸ì˜´
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œì„ ìœ„í•œ java ì„¤ì¹˜
      # ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ë†“ì€ ì•¡ì…˜ ì´ìš©
      - name: JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: '17' # ìë°” ë²„ì „
          distribution: 'temurin' # ì œê³µì
      
      # gradlew ì‹¤í–‰ì„ ìœ„í•œ ê¶Œí•œ ë¶€ì—¬
      - name: gradlew ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew # ì‹¤í–‰ê¶Œí•œë¶€ì—¬
      
      # gradleì„ ì´ìš©í•œ ë¹Œë“œ
      - name: Gradle í†µí•´ ë¹Œë“œ
        run: ./gradlew clean build # ë¹Œë“œ
      
      # ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸
      # ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ë†“ì€ ì•¡ì…˜ ì´ìš©
      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # ë„ì»¤ ë¡œê·¸ì¸ì„ ìœ„í•œ ìœ ì €ë„¤ì„
          password: ${{ secrets.DOCKERHUB_TOKEN }} # ë„ì»¤ ë¡œê·¸ì¸ì„ ìœ„í•œ í† í°
      
      # prì— ë”°ë¥¸ ë„ì»¤ ì´ë¯¸ì§€ ì´ë¦„ ë° í™˜ê²½ ì„¤ì •
      # develop -> ê°œë°œ, main -> ìš´ì˜
      - name: Docker ì´ë¯¸ì§€ ì´ë¦„ ë° í™˜ê²½ ì„¤ì •
        run: |
          if [[ "${{ github.event.pull_request.base.ref }}" == "main" ]]; then
            echo "IMAGE_NAME=fashion-forecast-prod" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.base.ref }}" == "develop" ]]; then
            echo "IMAGE_NAME=fashion-forecast-dev" >> $GITHUB_ENV
          fi
      
      # EC2ì—ì„œ ì‚¬ìš©í•˜ê¸°ìœ„í•´ ë„ì»¤ ë¹Œë“œ & í—ˆë¸Œì— í‘¸ì‹œ
      # ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ë†“ì€ ì•¡ì…˜ ì´ìš©
      - name: ë„ì»¤ ë¹Œë“œ & í‘¸ì‹œ
        uses: docker/build-push-action@v6
        with:
          context: . # ë„ì»¤ê°€ ë¹Œë“œë¥¼ ìˆ˜í–‰í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ 
          file: ./Dockerfile # ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ìˆëŠ” ë„ì»¤íŒŒì¼
          push: true # ì´ë¯¸ì§€ ë¹Œë“œ í›„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ
          platforms: linux/amd64 # ë¹Œë“œí•  í”Œë«í¼ ì§€ì • (EC2ì™€ ì¼ì¹˜)
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest # íƒœê·¸ ì§€ì •
  
  # 2. deploy
  deploy:
    # needs ì¡°ê±´ìœ¼ë¡œ buildê°€ ì„±ê³µí–ˆì„ë•Œë§Œ ì‹¤í–‰
    needs: build
    runs-on: ubuntu-latest # ìš°ë¶„íˆ¬ì—ì„œ ì‹¤í–‰
    steps:
      # prì— ë”°ë¥¸ ë°°í¬ íƒ€ê²Ÿ ì„¤ì •, ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì˜ ì´ë¦„ì„ ì„¤ì •í•˜ê¸° ìœ„í•¨
      # develop -> ê°œë°œ, main -> ìš´ì˜
      - name: ë°°í¬ íƒ€ê²Ÿ ì„¤ì •
        run: |
          if [[ "${{ github.event.pull_request.base.ref }}" == "main" ]]; then
            echo "DEPLOY_ENV=prod" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.base.ref }}" == "develop" ]]; then
            echo "DEPLOY_ENV=dev" >> $GITHUB_ENV
          fi
      
      # EC2 ì›ê²© ì ‘ì† ë° ë„ì»¤ì»´í¬ì¦ˆë¥¼ ì´ìš©í•œ ë¹Œë“œ
      # ë‹¤ë¥¸ ê°œë°œìê°€ ì •ì˜í•´ë†“ì€ ì•¡ì…˜ ì´ìš©
      - name: EC2 ì›ê²© ì ‘ì† ë° Docker compose
        uses: appleboy/ssh-action@master
        with:
          username: ${{ secrets.EC2_DEV_USERNAME }} # EC2 ìœ ì €ë„¤ì„
          host: ${{ secrets.EC2_DEV_HOST }} # EC2 í˜¸ìŠ¤íŠ¸
          key: ${{ secrets.EC2_DEV_PRIVATE_KEY }} # EC2 í‚¤(pemí‚¤)
          script_stop: true # ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤íŒ¨í–ˆì„ë•Œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¦‰ì‹œ ì¤‘ë‹¨
          # ë„ì»¤ ì´ë¯¸ì§€ ë‹¹ê²¨ì˜¤ê¸° 
          # develop -> fashion-forecast-dev:latest, main -> fashion-forecast-prod:latest
          # ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì´ìš©í•œ ë„ì»¤ ì´ë¯¸ì§€ ë‹¤ìš´ & ë¹Œë“œ(-fëŠ” ì‹¤í–‰ì „ í™•ì¸ ë©”ì„¸ì§€ë¥¼ ìƒëµí•˜ê³  ê°•ì œë¡œ ì‹¤í–‰, ë¹Œë“œëŠ” -d ì˜µì…˜ìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
          # develop -> docker-compose-dev.yml, main -> docker-compose-prod.yml
          # ë””ìŠ¤í¬ ê´€ë¦¬ë¥¼ ìœ„í•œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì‚­ì œ
          script: |
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/fashion-forecast-${{ env.DEPLOY_ENV }}:latest
            sudo docker compose -f docker-compose-${{ env.DEPLOY_ENV }}.yml down
            sudo docker compose -f docker-compose-${{ env.DEPLOY_ENV }}.yml up -d
            sudo docker image prune -f 

```

