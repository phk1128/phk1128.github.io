---
title: í…ŒìŠ¤íŠ¸í•˜ê¸° ì¢‹ì€ ì½”ë“œë¡œ ë¦¬íŒ©í† ë§
date: 2024-09-12
categories: [ OOTC ]
tags: [ Refactoring, í…ŒìŠ¤íŠ¸ ì½”ë“œ, Test ]
image: assets/posts/img_21.png
---

## ğŸ¬ Intro
> ì‚¬ì´ë“œí”Œì ì¸ OOTCì—ì„œ ì‚¬ìš©í•˜ëŠ” ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ì¢‹ì€ ì½”ë“œë¡œ ë¦¬íŒ©í† ë§ í•´ë³´ê² ìŠµë‹ˆë‹¤.


### âœ… Before

```java
@Component
@Slf4j
public class NationalForecastRegionReader {
    

    public List<Region> read() {

        try {
            ClassPathResource resource = new ClassPathResource("national_forecast_regions.csv");
            CSVReader csvReader = new CSVReader(new InputStreamReader(resource.getInputStream(), StandardCharsets.UTF_8));
            List<Region> regions = new ArrayList<>();
            String[] fields;

            // ì²« ë²ˆì§¸ ì¤„(í—¤ë”)ì„ ì½ê³  ë¬´ì‹œ
            csvReader.readNext();

            while ((fields = csvReader.readNext()) != null) {
                if (fields.length < 6) {
                    continue; // ì˜ëª»ëœ í˜•ì‹ì˜ ë¼ì¸ì€ ë¬´ì‹œí•©ë‹ˆë‹¤.
                }
                Region region = convertToRegion(fields);
                regions.add(region);
            }
            return regions;
        } catch (Exception e) {
            log.error(e.getMessage());
            throw new RuntimeException("national_forecast_regions.csvì„ ì½ì–´ì˜¤ëŠ”ë° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
        }

    }

    private Region convertToRegion(String[] fields) {
        String code = fields[0];
        String city = fields[1];
        String district = fields[2];
        String neighborhood = fields[3];
        String nx = fields[4];
        String ny = fields[5];

        Address address = new Address(code, city, district, neighborhood);
        return Region.builder()
                .address(address)
                .nx(nx)
                .ny(ny)
                .build();
    }
}
```

- ìœ„ ì½”ë“œëŠ” í•´ë‹¹ í´ë˜ìŠ¤ì˜ ë©”ì„œë“œì—ì„œ `ClassPathResource`, `CSVReader`ë¥¼ ì •ì˜í•˜ê³  ìˆì–´ì„œ ê°•ê²°í•© ìƒíƒœì…ë‹ˆë‹¤.
- ì´ ê²½ìš°ì—ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ì‹œ Mockingì„ í•˜ëŠ”ê²ƒì´ ë¶ˆê°€ëŠ¥ í•˜ë¯€ë¡œ ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ëŠ” í˜•íƒœë¡œ ë¦¬íŒ©í† ë§í•´ì•¼í•©ë‹ˆë‹¤.

### âœ… After

```java
@Configuration
public class FileReader {

    @Value("${national-forecast-regions}")
    private String fileName;

    @Bean
    @Qualifier("national_forecast_regions")
    public CSVReader csvReader() throws Exception {
        ClassPathResource resource = new ClassPathResource(fileName);
        return new CSVReader(new InputStreamReader(resource.getInputStream(), StandardCharsets.UTF_8));
    }
}
```

```java
@Component
@Slf4j
public class NationalForecastRegionReader {

    private final CSVReader csvReader;

    public NationalForecastRegionReader(@Qualifier("national_forecast_regions") CSVReader csvReader) {
        this.csvReader = csvReader;
    }

    public List<Region> read() {

        try {
            List<Region> regions = new ArrayList<>();
            String[] fields;

            // ì²« ë²ˆì§¸ ì¤„(í—¤ë”)ì„ ì½ê³  ë¬´ì‹œ
            csvReader.readNext();

            while ((fields = csvReader.readNext()) != null) {
                if (fields.length < 6) {
                    continue; // ì˜ëª»ëœ í˜•ì‹ì˜ ë¼ì¸ì€ ë¬´ì‹œí•©ë‹ˆë‹¤.
                }
                Region region = convertToRegion(fields);
                regions.add(region);
            }
            return regions;
        } catch (Exception e) {
            log.error(e.getMessage());
            throw new RuntimeException("national_forecast_regions.csvì„ ì½ì–´ì˜¤ëŠ”ë° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
        }

    }

    private Region convertToRegion(String[] fields) {
        String code = fields[0];
        String city = fields[1];
        String district = fields[2];
        String neighborhood = fields[3];
        String nx = fields[4];
        String ny = fields[5];

        Address address = new Address(code, city, district, neighborhood);
        return Region.builder()
                .address(address)
                .nx(nx)
                .ny(ny)
                .build();
    }
}
```
- csvReaderë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ê³ , ì´ë¥¼ ìƒì„±ì ì£¼ì…ì„ í†µí•´ ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ëŠ” í˜•íƒœë¡œ ë¦¬íŒ©í† ë§í•˜ì˜€ìŠµë‹ˆë‹¤.
- ì°¸ê³ ë¡œ ì–´ë– í•œ ë¹ˆì— ìƒì„±ìê°€ ì˜¤ì§ í•˜ë‚˜ë§Œ ìˆê³ , ìƒì„±ìì˜ íŒŒë¼ë¯¸í„° íƒ€ì…ì´ ë¹ˆìœ¼ë¡œ ë“±ë¡ê°€ëŠ¥í•œ ì¡´ì¬ë¼ë©´ ì´ ë¹ˆì€ `@Autowired` ì• ë…¸í‹°ì—ì…˜ ì—†ì´ë„
  ìë™ìœ¼ë¡œ ì˜ì¡´ì„± ì£¼ì…ì´ ë©ë‹ˆë‹¤.

```java
// @SpringBootTest ë¥¼ ë¶™ì—¬ë„ ë˜ì§€ë§Œ ê·¸ëŸ¬ë©´ ëª¨ë“  ìŠ¤í”„ë§ ì»¨í…ìŠ¤íŠ¸ê°€ ë¡œë“œ ë˜ê¸° ë•Œë¬¸ì— ëŠë ¤ì§„ë‹¤.
@ExtendWith(MockitoExtension.class)
class NationalForecastRegionReaderTest {

    @InjectMocks // @Mockìœ¼ë¡œ ì„ ì–¸ëœ ì–˜ë“¤ì„ @InjectMocksì— ë¶™ì€ê³³ì— ìë™ìœ¼ë¡œ ì„ ì–¸í•´ì¤€ë‹¤.
    private NationalForecastRegionReader nationalForecastRegionReader;

    @Mock
    private CSVReader csvReader;

    @BeforeEach
    public void setUp() throws Exception {
        when(csvReader.readNext()).thenReturn(
                new String[]{"code", "city", "district", "neighborhood", "nx", "ny"},
                new String[]{"001", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ë‚¨êµ¬", "ì‚¼ì„±ë™", "60", "127"},
                new String[]{"002", "ë¶€ì‚°ê´‘ì—­ì‹œ", "í•´ìš´ëŒ€êµ¬", "ì •ë™", "98", "76"},
                null
        );
    }

    @Test
    public void testRead_ì •ìƒ_ì¼€ì´ìŠ¤() {
        List<Region> regions = nationalForecastRegionReader.read();

        assertEquals(2, regions.size());
        assertEquals("001", regions.get(0).getAddress().getCode());
        assertEquals("ì„œìš¸íŠ¹ë³„ì‹œ", regions.get(0).getAddress().getCity());
        assertEquals("ê°•ë‚¨êµ¬", regions.get(0).getAddress().getDistrict());
        assertEquals("ì‚¼ì„±ë™", regions.get(0).getAddress().getNeighborhood());
        assertEquals("60", regions.get(0).getNx());
        assertEquals("127", regions.get(0).getNy());
    }

    @Test
    public void testRead_ì˜ëª»ëœ_í˜•ì‹ì˜_ë¼ì¸_ë¬´ì‹œ() throws Exception {
        when(csvReader.readNext()).thenReturn(
                new String[]{"code", "city", "district", "neighborhood", "nx", "ny"},
                new String[]{"001", "ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ë‚¨êµ¬", "ì‚¼ì„±ë™", "60", "127"},
                new String[]{"002", "ë¶€ì‚°ê´‘ì—­ì‹œ"},
                null
        );

        List<Region> regions = nationalForecastRegionReader.read();

        assertEquals(1, regions.size());
        assertEquals("001", regions.get(0).getAddress().getCode());
        assertEquals("ì„œìš¸íŠ¹ë³„ì‹œ", regions.get(0).getAddress().getCity());
        assertEquals("ê°•ë‚¨êµ¬", regions.get(0).getAddress().getDistrict());
        assertEquals("ì‚¼ì„±ë™", regions.get(0).getAddress().getNeighborhood());
        assertEquals("60", regions.get(0).getNx());
        assertEquals("127", regions.get(0).getNy());
    }

    @Test
    public void testRead_ì˜ˆì™¸_ë°œìƒ() throws Exception {
        when(csvReader.readNext()).thenThrow(new RuntimeException("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"));

        RuntimeException exception = assertThrows(RuntimeException.class, () -> {
            nationalForecastRegionReader.read();
        });

        assertThat(exception.getMessage()).isEqualTo("national_forecast_regions.csvì„ ì½ì–´ì˜¤ëŠ”ë° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
}
```
- csvReaderê°€ ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ëŠ” í˜•íƒœë¡œ ë¦¬íŒ©í† ë§ ë˜ì—ˆê¸° ë•Œë¬¸ì— Mockingì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.


- `@ExtendWith(MockitoExtension.class)`
  - **ëª©ì **: Mockitoë¥¼ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Unit Test) ì„¤ì •.
  - **ì‚¬ìš© ìš©ë„**: ì£¼ë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì—ì„œ Mockitoë¥¼ í™œìš©í•´ ëª¨ì˜(Mock) ê°ì²´ë¥¼ ì£¼ì…í•˜ê³  í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
  - **ë²”ìœ„**: ìŠ¤í”„ë§ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©°, í•„ìš”í•œ ê°ì²´ë§Œ ëª¨ì˜í•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
  - **ì†ë„**: ìŠ¤í”„ë§ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¡œë“œí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í…ŒìŠ¤íŠ¸ê°€ ë§¤ìš° ë¹ ë¥´ê²Œ ì‹¤í–‰ë©ë‹ˆë‹¤.


- `@SpringBootTest`
  - **ëª©ì **: ìŠ¤í”„ë§ ë¶€íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¡œë“œí•˜ê³  í†µí•© í…ŒìŠ¤íŠ¸(Integration Test)ë¥¼ ìˆ˜í–‰.
  - **ì‚¬ìš© ìš©ë„**: ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¡œë“œí•˜ì—¬ ì‹¤ì œ ë¹ˆ(bean)ë“¤ì„ í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
  - **ë²”ìœ„**: ìŠ¤í”„ë§ ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
  - **ì†ë„**: ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¡œë“œí•˜ë¯€ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì†ë„ê°€ ëŠë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
